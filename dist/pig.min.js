(function(l,a){typeof define=="function"&&define.amd?define([],a()):typeof module=="object"&&module.exports?module.exports=a():(l.Pig=a().Pig,l.ProgressiveImage=a().ProgressiveImage)})(typeof self!="undefined"?self:exports,function(){var l=class{constructor(t,e,i){return this.existsOnPage=!1,this.aspectRatio=t.aspectRatio,this.filename=t.filename,this.index=e,this.pig=i,this.classNames={figure:i.settings.classPrefix+"-figure",thumbnail:i.settings.classPrefix+"-thumbnail",loaded:i.settings.classPrefix+"-loaded"},this}load(){this.existsOnPage=!0,this._updateStyles(),this.pig.container.appendChild(this.getElement()),setTimeout(function(){!this.existsOnPage||this.addAllSubElements()}.bind(this),100)}hide(){this.getElement()&&this.removeAllSubElements(),this.existsOnPage&&this.pig.container.removeChild(this.getElement()),this.existsOnPage=!1}getElement(){return this.element||(this.element=document.createElement(this.pig.settings.figureTagName),this.element.className=this.classNames.figure,this.pig.settings.onClickHandler!==null&&this.element.addEventListener("click",function(){this.pig.settings.onClickHandler(this.filename)}.bind(this)),this._updateStyles()),this.element}addImageAsSubElement(t,e,i,n=""){let s=this[t];s||(this[t]=new Image,s=this[t],s.src=this.pig.settings.urlForSize(e,i),n.length>0&&(s.className=n),s.onload=function(){s&&(s.className+=" "+this.classNames.loaded)}.bind(this),this.getElement().appendChild(s))}addAllSubElements(){this.addImageAsSubElement("thumbnail",this.filename,this.pig.settings.thumbnailSize,this.classNames.thumbnail),this.addImageAsSubElement("fullImage",this.filename,this.pig.settings.getImageSize(this.pig.lastWindowWidth))}removeSubElement(t){const e=this[t];e&&(e.src="",this.getElement().removeChild(e),delete this[t])}removeAllSubElements(){this.removeSubElement("thumbnail"),this.removeSubElement("fullImage")}_updateStyles(){this.getElement().style.transition=this.style.transition,this.getElement().style.width=this.style.width+"px",this.getElement().style.height=this.style.height+"px",this.getElement().style.transform="translate3d("+this.style.translateX+"px,"+this.style.translateY+"px, 0)"}},a=class{constructor(){this._callbacks=[],this._running=!1}add(t){this._callbacks.length||window.addEventListener("resize",this._resize.bind(this)),this._callbacks.push(t)}disable(){window.removeEventListener("resize",this._resize.bind(this))}reEnable(){window.addEventListener("resize",this._resize.bind(this))}_resize(){this._running||(this._running=!0,window.requestAnimationFrame?window.requestAnimationFrame(this._runCallbacks.bind(this)):setTimeout(this._runCallbacks.bind(this),66))}_runCallbacks(){this._callbacks.forEach(function(t){t()}),this._running=!1}},d=class{constructor(){this.containerId="pig",this.scroller=window,this.classPrefix="pig",this.figureTagName="figure",this.spaceBetweenImages=8,this.transitionSpeed=500,this.primaryImageBufferHeight=1e3,this.secondaryImageBufferHeight=300,this.thumbnailSize=20,this.onClickHandler=null}urlForSize(t,e){return"/img/"+e.toString(10)+"/"+t}getMinAspectRatio(t){return t<=640?2:t<=1280?4:t<=1920?5:6}getImageSize(t){return t<=640?100:t<=1920?250:500}createProgressiveImage(t,e,i){return new l(t,e,i)}},u=class{constructor(t,e){return this._optimizedResize=new a,this.inRAF=!1,this.isTransitioning=!1,this.minAspectRatioRequiresTransition=!1,this.minAspectRatio=null,this.latestYOffset=0,this.lastWindowWidth=window.innerWidth,this.scrollDirection="down",this.visibleImages=[],this.settings=Object.assign(new d,e),this.container=document.getElementById(this.settings.containerId),this.container||console.error("Could not find element with ID "+this.settings.containerId),this.scroller=this.settings.scroller,this.images=this._parseImageData(t),this._injectStyle(this.settings.containerId,this.settings.classPrefix,this.settings.transitionSpeed),this}enable(){return this.onScroll=this._getOnScroll(),this.scroller.addEventListener("scroll",this.onScroll),this.onScroll(),this._computeLayout(),this._doLayout(),this._optimizedResize.add(function(){this.lastWindowWidth=this.scroller===window?window.innerWidth:this.scroller.offsetWidth,this._computeLayout(),this._doLayout()}.bind(this)),this}disable(){return this.scroller.removeEventListener("scroll",this.onScroll),this._optimizedResize.disable(),this}_parseImageData(t){const e=[];return t.forEach(function(i,n){const s=this.settings.createProgressiveImage(i,n,this);e.push(s)}.bind(this)),e}_getOffsetTop(t){let e=0;do isNaN(t.offsetTop)||(e+=t.offsetTop),t=t.offsetParent;while(t);return e}_injectStyle(t,e,i){const n="#"+t+" {  position: relative;}."+e+"-figure {  background-color: #D5D5D5;  overflow: hidden;  left: 0;  position: absolute;  top: 0;  margin: 0;}."+e+"-figure img {  left: 0;  position: absolute;  top: 0;  height: 100%;  width: 100%;  opacity: 0;  transition: "+(i/1e3).toString(10)+"s ease opacity;  -webkit-transition: "+(i/1e3).toString(10)+"s ease opacity;}."+e+"-figure img."+e+"-thumbnail {  -webkit-filter: blur(30px);  filter: blur(30px);  left: auto;  position: relative;  width: auto;}."+e+"-figure img."+e+"-loaded {  opacity: 1;}",s=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.appendChild(document.createTextNode(n)),s.appendChild(o)}_getTransitionTimeout(){const t=1.5;return this.settings.transitionSpeed*t}_getTransitionString(){return this.isTransitioning?(this.settings.transitionSpeed/1e3).toString(10)+"s transform ease":"none"}_recomputeMinAspectRatio(){const t=this.minAspectRatio;this.minAspectRatio=this.settings.getMinAspectRatio(this.lastWindowWidth),t!==null&&t!==this.minAspectRatio?this.minAspectRatioRequiresTransition=!0:this.minAspectRatioRequiresTransition=!1}_computeLayout(){const t=parseInt(this.container.clientWidth,10);let e=[],i=0,n=0,s=0;this._recomputeMinAspectRatio(),!this.isTransitioning&&this.minAspectRatioRequiresTransition&&(this.isTransitioning=!0,setTimeout(function(){this.isTransitioning=!1},this._getTransitionTimeout()));const o=this._getTransitionString();[].forEach.call(this.images,function(r,f){if(s+=parseFloat(r.aspectRatio),e.push(r),s>=this.minAspectRatio||f+1===this.images.length){s=Math.max(s,this.minAspectRatio);const h=(t-this.settings.spaceBetweenImages*(e.length-1))/s;e.forEach(function(c){const g=h*c.aspectRatio;c.style={width:parseInt(g,10),height:parseInt(h,10),translateX:i,translateY:n,transition:o},i+=g+this.settings.spaceBetweenImages}.bind(this)),e=[],s=0,n+=parseInt(h,10)+this.settings.spaceBetweenImages,i=0}}.bind(this)),this.totalHeight=n-this.settings.spaceBetweenImages}_doLayout(){this.container.style.height=this.totalHeight+"px";const t=this.scrollDirection==="up"?this.settings.primaryImageBufferHeight:this.settings.secondaryImageBufferHeight,e=this.scrollDirection==="down"?this.settings.secondaryImageBufferHeight:this.settings.primaryImageBufferHeight,i=this._getOffsetTop(this.container),n=this.scroller===window?window.innerHeight:this.scroller.offsetHeight,s=this.latestYOffset-i-t,o=this.latestYOffset-i+n+e;this.images.forEach(function(r){r.style.translateY+r.style.height<s||r.style.translateY>o?r.hide():r.load()})}_getOnScroll(){const t=this;return()=>{const i=t.scroller===window?window.pageYOffset:t.scroller.scrollTop;t.previousYOffset=t.latestYOffset||i,t.latestYOffset=i,t.scrollDirection=t.latestYOffset>t.previousYOffset?"down":"up",t.inRAF||(t.inRAF=!0,window.requestAnimationFrame(()=>{t._doLayout(),t.inRAF=!1}))}}};return{Pig:u,ProgressiveImage:l}});
